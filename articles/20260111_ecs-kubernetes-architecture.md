---
title: "Kubernetesã®ãƒãƒªã§å­¦ã¶ECSã®ä»•çµ„ã¿"
emoji: "ğŸš¢"
type: "tech"
topics: ["aws", "ecs", "kubernetes", "ã‚³ãƒ³ãƒ†ãƒŠ"]
published: false
---

## 0. ã¯ã˜ã‚ã«

### èª­è€…å‰æ

ã“ã®è¨˜äº‹ã¯ä»¥ä¸‹ã®æ–¹ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

- Kubernetesã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆdesired state / controller loop / scheduler / kubelet ãªã©ï¼‰ã‚’ç†è§£ã—ã¦ã„ã‚‹
- ECSã‚’è§¦ã£ãŸã“ã¨ãŒã‚ã‚‹ï¼ˆService / TaskDefinition / Task ã®ç”¨èªã¯çŸ¥ã£ã¦ã„ã‚‹ï¼‰
- ãŸã ã— EKS ã¯è§¦ã£ã¦ã„ãªã„æ–¹ã‚‚èª­ã‚€æƒ³å®š

### æœ¬ç¨¿ã®ç¯„å›²

æœ¬ç¨¿ã¯ **ã€ŒECS vs Kubernetesï¼ˆä¸€èˆ¬ï¼‰ã€** ã¨ã—ã¦ã€ECSã®ä»•çµ„ã¿ã‚’k8sè„³ã«ç¿»è¨³ã™ã‚‹ã“ã¨ãŒç›®çš„ã§ã™ã€‚

EKSã¯ "AWSã§Kubernetesã‚’å‹•ã‹ã™ä»£è¡¨ä¾‹" ã¨ã—ã¦åå‰ãŒå‡ºã‚‹ç¨‹åº¦ã«ç•™ã‚ã€**EKSç‰¹æœ‰ã®é‹ç”¨è«–ï¼ˆã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã€ã‚¢ãƒ‰ã‚ªãƒ³é¸å®šã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ç­‰ï¼‰ã«ã¯è¸ã¿è¾¼ã¿ã¾ã›ã‚“**ã€‚

### ã“ã®è¨˜äº‹ã®ã‚´ãƒ¼ãƒ«ï¼ˆ1è¡Œã§æŒã¡å¸°ã£ã¦ã»ã—ã„ã“ã¨ï¼‰

**ã€ŒECSã‚‚Kubernetesã‚‚ã€desired state ã‚’åˆ¶å¾¡ãƒ«ãƒ¼ãƒ—ï¼ˆreconciliationï¼‰ã§ç¾å®Ÿã«å¯„ã›ã¦åæŸã•ã›ã‚‹ã€**

ã“ã®ã‚·ãƒ³ãƒ—ãƒ«ãªè¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã®å…±é€šæ€§ã‚’ç†è§£ã™ã‚Œã°ã€k8sã§å­¦ã‚“ã æ€è€ƒæ³•ãŒãã®ã¾ã¾ECSã«ã‚‚é©ç”¨ã§ãã¾ã™ã€‚

---

## 1. ã¾ãš"åŒã˜éª¨æ ¼"ã‚’ç¢ºèªã™ã‚‹ï¼ˆè¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã®å…±é€šé …ï¼‰

Kubernetesã‚‚ECSã‚‚ã€æ ¹åº•ã«ã‚ã‚‹è¨­è¨ˆæ€æƒ³ã¯åŒã˜ã§ã™ã€‚

### Desired Stateï¼ˆå®£è¨€çš„ãªçŠ¶æ…‹ï¼‰

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã“ã†ã‚ã£ã¦ã»ã—ã„ã€ã¨ã„ã†çŠ¶æ…‹ã‚’å®£è¨€ã™ã‚‹ã€‚

- **Kubernetes**: Deployment YAML ã® `replicas: 3`
- **ECS**: Service ã® `desiredCount: 3`

### Reconciliation Loopï¼ˆåˆ¶å¾¡ãƒ«ãƒ¼ãƒ—ï¼‰

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãŒç¾å®Ÿã®çŠ¶æ…‹ã‚’ç›£è¦–ã—ã€desired stateã«åæŸã•ã›ç¶šã‘ã‚‹ã€‚

- **Kubernetes**: Deployment Controllerã€ReplicaSet Controller
- **ECS**: ECS Service Schedulerï¼ˆå†…éƒ¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰

### Schedulingï¼ˆé…ç½®æ±ºå®šï¼‰

æ–°ã—ã„ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚’ã€Œã©ã“ã«ã€ç½®ãã‹ã‚’æ±ºã‚ã‚‹ã€‚

- **Kubernetes**: kube-scheduler
- **ECS**: ECS Placementï¼ˆcapacity provider + placement strategy/constraintï¼‰

### Data Plane / Node Agentï¼ˆå®Ÿè¡Œä¸»ä½“ï¼‰

å®Ÿéš›ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ãƒ»ç›£è¦–ã™ã‚‹ã€‚

- **Kubernetes**: kubeletï¼ˆå„ãƒãƒ¼ãƒ‰ä¸Šï¼‰
- **ECS**: ECS Agentï¼ˆEC2ãƒ¢ãƒ¼ãƒ‰ï¼‰/ ä¸å¯è¦–ï¼ˆFargateï¼‰

### ã“ã“ã§å®£è¨€ï¼šECSã¨Kubernetesã¯åŒå‹

ä¸¡è€…ã¯**ç•°ãªã‚‹APIã¨ç”¨èªã‚’ä½¿ã£ã¦ã„ã‚‹ãŒã€åˆ¶å¾¡æ§‹é€ ã¯åŒå‹**ã§ã™ã€‚
ä»¥é™ã€ã“ã®å¯¾å¿œé–¢ä¿‚ã‚’å…·ä½“çš„ã«è¦‹ã¦ã„ãã¾ã™ã€‚

---

## 2. ç¿»è¨³è¾æ›¸ï¼šk8sè„³â†’ECSè„³ã®å¯¾å¿œè¡¨

| Kubernetes | ECS | å‚™è€ƒ |
|------------|-----|------|
| **Deployment / ReplicaSet** | **Service** | desired stateï¼ˆãƒ¬ãƒ—ãƒªã‚«æ•°ã€ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆåˆ¶å¾¡ï¼‰ã‚’ç®¡ç† |
| **Pod** | **Task** | å®Ÿè¡Œå˜ä½ï¼ˆ1ã¤ä»¥ä¸Šã®ã‚³ãƒ³ãƒ†ãƒŠï¼‰ |
| **PodSpecï¼ˆã‚³ãƒ³ãƒ†ãƒŠå®šç¾©ï¼‰** | **TaskDefinition** | immutableãªè¨­è¨ˆå›³ï¼ˆrevisionç®¡ç†ï¼‰ |
| **kube-scheduler** | **ECS Placement** | ã©ã“ã«é…ç½®ã™ã‚‹ã‹ã‚’æ±ºå®š |
| **kubelet** | **ECS Agentï¼ˆEC2ï¼‰/ ä¸å¯è¦–ï¼ˆFargateï¼‰** | ã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡Œã¨Control Planeã¨ã®åŒæœŸ |
| **kubectl describe / events** | **Service Events / Task Stopped Reason** | çŠ¶æ…‹é·ç§»ã¨ç•°å¸¸ã®è¦³æ¸¬ |
| **Serviceï¼ˆClusterIP/LBï¼‰** | **Target Group + awsvpc** | ã‚µãƒ¼ãƒ“ã‚¹ç™ºè¦‹ã¨ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚° |
| **ServiceAccount + IRSA** | **Task Role + Execution Role** | IAMæ¨©é™ã®è²¬å‹™åˆ†é›¢ |
| **maxSurge / maxUnavailable** | **maximumPercent / minimumHealthyPercent** | ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆä¸­ã®ä¸¦èµ°åˆ¶å¾¡ï¼ˆç™ºæƒ³ã¯åŒã˜ã€è¨€è‘‰ã¯é€†ï¼‰ |

ã“ã®è¡¨ã‚’é ­ã«å…¥ã‚Œã¦ãŠã‘ã°ã€ECSã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚€ã¨ãã«ã€Œã‚ã€ã“ã‚Œk8sã®â—¯â—¯ã ã€ã¨ãƒ”ãƒ³ã¨ãã¾ã™ã€‚

---

## 3. desired state ã®å˜ä½ã‚’åˆ†è§£ã™ã‚‹ï¼šService / TaskDefinition / Deployment

### TaskDefinition ã¯ immutable ãªè¨­è¨ˆå›³

TaskDefinitionã¯**ã‚¤ãƒŸãƒ¥ãƒ¼ã‚¿ãƒ–ãƒ«**ã§ã™ã€‚å¤‰æ›´ã™ã‚‹ã¨revisionãŒä¸ŠãŒã‚Šã¾ã™ã€‚

```plaintext
my-app:1 â†’ my-app:2 â†’ my-app:3
```

ã“ã‚Œã¯k8sã®PodSpecã«è¿‘ã„ã§ã™ãŒã€k8sã¨é•ã£ã¦**ä¸–ä»£ãŒãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã•ã‚Œã‚‹**ç‚¹ãŒç‰¹å¾´ã§ã™ã€‚

### Service ã¯ desired state ã®ä¸»ä½“

ECS Serviceã¯ä»¥ä¸‹ã‚’ç®¡ç†ã—ã¾ã™ã€‚

- **desiredCount**ï¼ˆä½•å€‹å‹•ã‹ã™ã‹ï¼‰
- **ä½¿ç”¨ã™ã‚‹TaskDefinition**ï¼ˆã©ã®revisionã‚’ä½¿ã†ã‹ï¼‰
- **deployment configuration**ï¼ˆãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã®åˆ¶ç´„ï¼‰
- **placement strategy / constraint**ï¼ˆã©ã“ã«ç½®ãã‹ï¼‰

### Deploymentï¼ˆECSç”¨èªï¼‰ã¯ã€Œä¸–ä»£ã®ä¸¦èµ°â†’åæŸã€ã‚’è¡¨ã™

ECS Serviceå†…éƒ¨ã«ã¯ **`deployments`** ã¨ã„ã†çŠ¶æ…‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã—ã¾ã™ï¼ˆè¤‡æ•°å½¢ã§ã‚ã‚‹ã“ã¨ã«æ³¨æ„ï¼‰ã€‚

```plaintext
â”Œâ”€ ECS Service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ desiredCount: 3                   â”‚
â”‚                                   â”‚
â”‚ deployments:                      â”‚
â”‚  - PRIMARY (my-app:2)  â†’ 3 tasks  â”‚  â† æ–°ã—ã„revision
â”‚  - ACTIVE  (my-app:1)  â†’ 0 tasks  â”‚  â† å¤ã„revisionãŒåæŸå®Œäº†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆä¸­ã¯**PRIMARYï¼ˆæ–°ï¼‰ã¨ACTIVEï¼ˆæ—§ï¼‰ãŒä¸¦èµ°**ã—ã€å¾ã€…ã«æ–°ã—ã„æ–¹ã«ã‚·ãƒ•ãƒˆã—ã¾ã™ã€‚
ã“ã‚Œã¯k8sã®ReplicaSetã®ä¸¦èµ°ï¼ˆå¤ã„RSã®replicasæ¸›ã€æ–°ã—ã„RSå¢—ï¼‰ã¨åŒã˜è€ƒãˆæ–¹ã§ã™ã€‚

---

## 4. ECSã®reconciliation loopï¼šä½•ã‚’å…¥åŠ›ã«ã€ä½•ã‚’å‡ºåŠ›ã™ã‚‹ã®ã‹

### å…¥åŠ›ï¼ˆè¦³æ¸¬ã™ã‚‹çŠ¶æ…‹ï¼‰

ECS Service Schedulerã¯ä»¥ä¸‹ã‚’å…¥åŠ›ã¨ã—ã¦å—ã‘å–ã‚Šã¾ã™ã€‚

- **deployments ã® desired / running / pending**
- **Task ã® state**ï¼ˆRUNNING / PENDING / STOPPEDï¼‰
- **ï¼ˆLBé€£æºæ™‚ã®ï¼‰ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæœ**
- **Capacity Provider ã®ç©ºãçŠ¶æ³**ï¼ˆFargate / EC2ï¼‰

### å‡ºåŠ›ï¼ˆåˆ¶å¾¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

- **RunTask**ï¼ˆæ–°ã—ã„Taskã‚’èµ·å‹•ï¼‰
- **StopTask**ï¼ˆå¤ã„Taskã‚’åœæ­¢ï¼‰
- **å¾…æ©Ÿ**ï¼ˆåˆ¶ç´„ã‚’æº€ãŸã™ã¾ã§ä½•ã‚‚ã—ãªã„ï¼‰

### deployment config ã®åˆ¶ç´„

ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆä¸­ã®ä¸¦èµ°æ•°ã¨å¥å…¨æ€§ã‚’åˆ¶å¾¡ã™ã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€‚

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | æ„å‘³ | k8sã§ã®é¡ä¼¼æ¦‚å¿µ |
|-----------|------|----------------|
| **minimumHealthyPercent** | æœ€ä½ä½•%ã‚’å¥å…¨ã«ä¿ã¤ã‹ | 100 - maxUnavailable |
| **maximumPercent** | æœ€å¤§ä½•%ã¾ã§ä¸¦èµ°ã‚’è¨±ã™ã‹ | 100 + maxSurge |

ä¾‹ï¼š`minimumHealthyPercent: 50, maximumPercent: 200, desiredCount: 4`

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æœ€ä½ 2 (50%) ã¯å¸¸ã«å¥å…¨             â”‚
â”‚ æœ€å¤§ 8 (200%) ã¾ã§ä¸¦èµ°å¯èƒ½          â”‚
â”‚                                    â”‚
â”‚ â†’ å¤ã„4ã¤ã‚’æ®‹ã—ãŸã¾ã¾æ–°4ã¤èµ·å‹•OK   â”‚
â”‚ â†’ æ–°ãŒå¥å…¨ã«ãªã£ãŸã‚‰å¤ã‚’åœæ­¢        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ã“ã®ãƒ«ãƒ¼ãƒ—ã¯**å¤–ã‹ã‚‰è¦³æ¸¬ã§ãã‚‹äº‹å®Ÿï¼ˆtask state, service eventsï¼‰ã«åŸºã¥ã„ã¦æ¨æ¸¬ã™ã‚‹**ã—ã‹ã‚ã‚Šã¾ã›ã‚“ãŒã€å‹•ä½œãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ä¸Šè¨˜ã®åˆ¶ç´„ã«å¾“ã„ã¾ã™ã€‚

---

## 5. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ï¼škube-schedulerç›¸å½“ã‚’ECSã§ã©ã†æ‰ãˆã‚‹ã‹

ECSã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã¯**äºŒæ®µéš**ã§è€ƒãˆã‚‹ã¨æ•´ç†ã—ã‚„ã™ã„ã§ã™ã€‚

### â‘  ã©ã®ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ã‚’ä½¿ã†ã‹

- **Fargate**: ãƒãƒ¼ãƒ‰ç®¡ç†ä¸è¦ã€ã‚¿ã‚¹ã‚¯å˜ä½ã§èµ·å‹•
- **EC2 (Capacity Provider)**: ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
- **External (ECS Anywhere)**: ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ç­‰

ã“ã‚Œã¯k8sã®ã€Œã©ã®ãƒãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«ã«é…ç½®ã™ã‚‹ã‹ã€ã«ç›¸å½“ã—ã¾ã™ãŒã€ECSã§ã¯**Capacity Provider**ã¨ã„ã†æŠ½è±¡ã§è¡¨ç¾ã•ã‚Œã¾ã™ã€‚

### â‘¡ ãã®ä¸­ã§ã©ã“ã«ç½®ãã‹ï¼ˆPlacementï¼‰

**Placement Strategy**:

- `spread`: AZ/ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã°ã‚‰ã¾ã
- `binpack`: ãƒªã‚½ãƒ¼ã‚¹åŠ¹ç‡ã‚’å„ªå…ˆã—ã¦è©°ã‚è¾¼ã‚€
- `random`: ãƒ©ãƒ³ãƒ€ãƒ 

**Placement Constraint**:

- `memberOf`: ç‰¹å®šã®å±æ€§ã‚’æŒã¤ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«é™å®šï¼ˆä¾‹ï¼š`attribute:ecs.instance-type =~ t3.*`ï¼‰

### Fargateã®å ´åˆ

ãƒãƒ¼ãƒ‰é¸æŠãŒæŠ½è±¡åŒ–ã•ã‚Œã€åˆ¶ç´„ã¯**ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆã‚µãƒ–ãƒãƒƒãƒˆï¼‰ã¨ãƒªã‚½ãƒ¼ã‚¹è¦æ±‚**ã®å½¢ã§è¡¨ç¾ã•ã‚Œã¾ã™ã€‚
kubeletã‚„ãƒãƒ¼ãƒ‰å´ã®åˆ¶ç´„ï¼ˆtaint/tolerationç­‰ï¼‰ã¯æ„è­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

---

## 6. Data Plane ã¨è²¬å‹™å¢ƒç•Œï¼šECS agent / Fargate ã®è¦‹ãˆæ–¹

### EC2ãƒ¢ãƒ¼ãƒ‰ï¼šECS Agent ãŒè¦‹ãˆã‚‹

```plaintext
â”Œâ”€ Control Plane (ECS) â”€â”
â”‚  Service Scheduler     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ (API)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ECS Agent (EC2ä¸Š)     â”‚  â† kubeletã«ç›¸å½“
â”‚  - TaskçŠ¶æ…‹ã®å ±å‘Š      â”‚
â”‚  - ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•/åœæ­¢   â”‚
â”‚  - Docker/containerdã¨é€šä¿¡ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

EC2ä¸Šã®**ECS Agent**ã¯Control Planeã¨åŒæœŸã—ã€ã‚¿ã‚¹ã‚¯ã®èµ·å‹•/åœæ­¢ã‚’æ‹…ã„ã¾ã™ã€‚
ã“ã‚Œã¯kubeletã¨åŒã˜è²¬å‹™ã§ã™ã€‚

### Fargateï¼šãƒãƒ¼ãƒ‰å´ãŒä¸å¯è¦–

```plaintext
â”Œâ”€ Control Plane (ECS) â”€â”
â”‚  Service Scheduler     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ (API)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Fargateï¼ˆãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰â”‚  â† ãƒãƒ¼ãƒ‰å´ã«ä»‹å…¥ã§ããªã„
â”‚  - ã‚¿ã‚¹ã‚¯å˜ä½ã§èµ·å‹•    â”‚
â”‚  - ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†ä¸è¦    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Fargateã¯**ãƒãƒ¼ãƒ‰å´ã®éƒ¨å“ãŒå®Œå…¨ã«éš è”½**ã•ã‚Œã¾ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦³æ¸¬ã§ãã‚‹ã®ã¯**ã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹ãƒ»ç†ç”±ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ**ã®ã¿ã§ã™ã€‚

### k8sã¨ã®é•ã„

- **k8s**: ãƒãƒ¼ãƒ‰å´ã®éƒ¨å“ï¼ˆkubelet / CNI / CSIï¼‰ãŒéœ²å‡ºã—ã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå¯èƒ½
- **ECS**: ã‚¿ã‚¹ã‚¯å˜ä½ã®çŠ¶æ…‹/ç†ç”±/ã‚¤ãƒ™ãƒ³ãƒˆãŒä¸»èªã€‚ãƒãƒ¼ãƒ‰å´ã¯ï¼ˆFargateã§ã¯ï¼‰ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹

---

## 7. awsvpc ã‚’ä¸­å¿ƒã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’èªã‚‹ï¼ˆã‚¿ã‚¹ã‚¯=ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¢ƒç•Œï¼‰

### ã‚¿ã‚¹ã‚¯ãŒENIã‚’æŒã¤ã¨ã„ã†è¨­è¨ˆ

ECSã®**awsvpcãƒ¢ãƒ¼ãƒ‰**ã§ã¯ã€**1 Task = 1 ENI**ã§ã™ã€‚

```plaintext
â”Œâ”€ VPC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                   â”‚
â”‚  â”Œâ”€ Task (ENI) â”€â”                â”‚
â”‚  â”‚  IP: 10.0.1.5  â”‚  â† ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ç›´æ¥é©ç”¨ â”‚
â”‚  â”‚  Container A   â”‚                â”‚
â”‚  â”‚  Container B   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã“ã‚ŒãŒæ„å‘³ã™ã‚‹ã“ã¨

- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—**: ã‚¿ã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã§ç›´æ¥é©ç”¨ï¼ˆPodã«SGã‚’å½“ã¦ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
- **åˆ°é”æ€§**: ã‚¿ã‚¹ã‚¯IPãŒVPCå†…ã§ç›´æ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å¯èƒ½
- **ã‚µãƒ¼ãƒ“ã‚¹ç™ºè¦‹**: Cloud Map / Target GroupãŒã‚¿ã‚¹ã‚¯IPã‚’ç›´æ¥å‚ç…§
- **ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°**: ALB/NLBãŒã‚¿ã‚¹ã‚¯IPã«ç›´æ¥ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’é€ã‚‹

### k8sã®Pod IPã¨ã®è¿‘ã•ã¨é•ã„

- **è¿‘ã•**: ã©ã¡ã‚‰ã‚‚ã€Œãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰å˜ä½ã§IPã‚’æŒã¤ã€
- **é•ã„**: ECSã¯AWSãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ¶ç´„ï¼ˆENIä¸Šé™ã€ã‚µãƒ–ãƒãƒƒãƒˆè¨­è¨ˆï¼‰ãŒ**ç›´ã«åŠ¹ã**
  - ENIæ•°ä¸Šé™ã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ä¾å­˜
  - Fargateã¯1ã‚¿ã‚¹ã‚¯=1ENIãŒå¼·åˆ¶

---

## 8. IAMï¼šexecution role ã¨ task role ã‚’"è²¬å‹™åˆ†é›¢"ã¨ã—ã¦ç†è§£ã™ã‚‹

ECSã«ã¯2ç¨®é¡ã®IAMãƒ­ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚

### Execution Roleï¼ˆèµ·å‹•ã®ãŸã‚ï¼‰

ã‚¿ã‚¹ã‚¯**èµ·å‹•æ™‚**ã«ECSãŒå¿…è¦ã¨ã™ã‚‹æ¨©é™ã€‚

- ECRã‹ã‚‰ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’pull
- CloudWatch Logsã«ãƒ­ã‚°ã‚’é€ä¿¡
- Secrets Managerã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’æ³¨å…¥

**èª°ãŒä½¿ã†ã‹**: ECSï¼ˆControl Planeå´ï¼‰

### Task Roleï¼ˆå®Ÿè¡Œä¸­ã®ã‚¢ãƒ—ãƒªã®ãŸã‚ï¼‰

ã‚¿ã‚¹ã‚¯**å®Ÿè¡Œä¸­**ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒAWS APIã‚’å©ãæ¨©é™ã€‚

- S3ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
- DynamoDBã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿
- SQSã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—

**èª°ãŒä½¿ã†ã‹**: ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

### k8sã®ServiceAccount / IRSAï¼ˆä¸€èˆ¬æ¦‚å¿µï¼‰ã¨ã®å¯¾æ¯”

| Kubernetes | ECS | è²¬å‹™ |
|------------|-----|------|
| **Node IAM Roleï¼ˆæš—é»™ï¼‰** | **Execution Role** | èµ·å‹•ãƒ»ã‚¤ãƒ³ãƒ•ãƒ©æ“ä½œ |
| **ServiceAccount + IRSA** | **Task Role** | ã‚¢ãƒ—ãƒªãŒAWS APIã‚’å©ã |

**æ³¨æ„**: EKSã§ã®IRSAé‹ç”¨è«–ï¼ˆOIDCè¨­å®šã€Podã¸ã®æ³¨å…¥æ–¹æ³•ç­‰ï¼‰ã¯æœ¬ç¨¿ã®ã‚¹ã‚³ãƒ¼ãƒ—å¤–ã§ã™ã€‚
ã“ã“ã§ã¯ã€Œè²¬å‹™åˆ†é›¢ã®è€ƒãˆæ–¹ãŒåŒã˜ã€ã¨ã„ã†ç‚¹ã ã‘æŠ¼ã•ãˆã¦ãã ã•ã„ã€‚

---

## 9. è¦³æ¸¬ï¼škubectl describe ã®ä»£æ›¿ã¨ã—ã¦ã® "ECSã®çœŸå®Ÿã‚½ãƒ¼ã‚¹"

k8sã§ `kubectl describe pod` ã‚„ `kubectl get events` ã‚’è¦‹ã‚‹ç¿’æ…£ãŒã‚ã‚‹äººå‘ã‘ã«ã€ECSã§ã®è¦³æ¸¬å„ªå…ˆé †ä½ã‚’ç¤ºã—ã¾ã™ã€‚

### å„ªå…ˆé †ä½ï¼ˆåˆ¶å¾¡ãƒ«ãƒ¼ãƒ—ã®åˆ¤æ–­ã‚’è¿½ã†ï¼‰

1. **Service Events**
   - `ecs describe-services` ã® `events` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
   - ã€Œãªãœã‚¿ã‚¹ã‚¯ãŒèµ·å‹•/åœæ­¢ã—ãŸã‹ã€ã®åˆ¤æ–­ç†ç”±ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹
   - ä¾‹ï¼š`(service my-service) has reached a steady state.`

2. **Deploymentsï¼ˆServiceå†…éƒ¨ã®çŠ¶æ…‹ï¼‰**
   - PRIMARY / ACTIVE ã®ä¸¦èµ°çŠ¶æ³
   - `desiredCount` / `runningCount` / `pendingCount`

3. **Task Stopped Reason / Exit Code**
   - `ecs describe-tasks` ã® `stoppedReason` ã¨ `containers[].exitCode`
   - ä¾‹ï¼š`Essential container in task exited`

4. **Logs / Metrics**
   - CloudWatch Logsï¼ˆã‚³ãƒ³ãƒ†ãƒŠã®æ¨™æº–å‡ºåŠ›ï¼‰
   - CloudWatch Metricsï¼ˆCPU/Memoryä½¿ç”¨ç‡ï¼‰

### ãªãœã“ã®é †ãªã®ã‹

ECSã®åˆ¶å¾¡ãƒ«ãƒ¼ãƒ—ã¯**Service â†’ Deployments â†’ Tasks**ã¨ã„ã†éšå±¤ã§å‹•ãã¾ã™ã€‚
**ä¸Šä½ã®åˆ¤æ–­**ãŒä¸‹ä½ã«å½±éŸ¿ã™ã‚‹ãŸã‚ã€ã¾ãšä¸Šä½ï¼ˆService Eventsï¼‰ã‹ã‚‰è¿½ã†ã“ã¨ã§ã€Œãªãœã“ã†ãªã£ãŸã‹ã€ãŒè¦‹ãˆã¾ã™ã€‚

ã“ã‚Œã¯k8sã§ã€ŒDeployment â†’ ReplicaSet â†’ Pod â†’ Containerã€ã¨è¿½ã†æ€è€ƒæ³•ã¨åŒã˜ã§ã™ã€‚

---

## 10. ã¾ã¨ã‚ï¼šk8sãƒãƒªã§ECSã‚’èª­ã‚€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ECSã‚’è§¦ã‚‹ã¨ãã€ä»¥ä¸‹ã‚’è‡ªå•ã™ã‚‹ã¨æ•´ç†ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚

### âœ… desiredã¯ã©ã“ï¼Ÿ

â†’ **Service ã® `desiredCount`** ã¨ **TaskDefinition ã®revision**

### âœ… ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã¯èª°ï¼Ÿ

â†’ **ECS Service Scheduler**ï¼ˆå†…éƒ¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€ç›´æ¥è§¦ã‚Œãªã„ï¼‰

### âœ… ã©ã“ã§çŠ¶æ…‹ãŒè¦‹ãˆã‚‹ï¼Ÿ

â†’ **Service Events â†’ Deployments â†’ Task State**ï¼ˆã“ã®é †ã§è¿½ã†ï¼‰

### âœ… ã©ã“ã§æ­»ã‚“ã ï¼Ÿ

â†’ **Task Stopped Reason â†’ Container Exit Code â†’ CloudWatch Logs**

---

## ãŠã‚ã‚Šã«

Kubernetesã‚‚ECSã‚‚ã€**desired state ã‚’åˆ¶å¾¡ãƒ«ãƒ¼ãƒ—ã§åæŸã•ã›ã‚‹**ã¨ã„ã†è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã¯åŒã˜ã§ã™ã€‚

- ç”¨èªã¯é•ã†ï¼ˆDeployment vs Serviceã€Pod vs Taskï¼‰
- APIã¯é•ã†ï¼ˆkubectl vs aws ecsï¼‰
- ã§ã‚‚**åˆ¶å¾¡æ§‹é€ ã¯åŒå‹**

k8sã§å­¦ã‚“ã ã€ŒçŠ¶æ…‹ã€ã€Œåˆ¶ç´„ã€ã€Œè²¬å‹™å¢ƒç•Œã€ã€Œå…¥åŠ›/å‡ºåŠ›ã€ã®æ€è€ƒæ³•ã¯ã€ãã®ã¾ã¾ECSã«ã‚‚é©ç”¨ã§ãã¾ã™ã€‚

ECSã‚’ã€Œã‚ˆãã‚ã‹ã‚‰ãªã„AWSã®ã‚³ãƒ³ãƒ†ãƒŠã‚µãƒ¼ãƒ“ã‚¹ã€ã¨ã—ã¦æ‰ãˆã‚‹ã®ã§ã¯ãªãã€ã€Œk8sã¨åŒã˜è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã§å‹•ãã€AWSç‰¹åŒ–å‹ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ã€ã¨ã—ã¦è¦‹ã‚‹ã¨ã€ç†è§£ãŒä¸€æ°—ã«é€²ã‚€ã¯ãšã§ã™ã€‚

---

## ä»˜éŒ²ï¼šå›³è§£

### å›³1: ECS vs k8s ã® Control Plane / Data Plane

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Control Plane                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Kubernetes        â”‚   ECS                             â”‚
â”‚                     â”‚                                   â”‚
â”‚  - API Server       â”‚  - ECS API                        â”‚
â”‚  - etcd             â”‚  - (å†…éƒ¨DBã€éå…¬é–‹)               â”‚
â”‚  - Scheduler        â”‚  - Service Scheduler + Placement â”‚
â”‚  - Controllers      â”‚  - (å†…éƒ¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã€éå…¬é–‹)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Data Plane                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Kubernetes        â”‚   ECS                             â”‚
â”‚                     â”‚                                   â”‚
â”‚  - kubelet          â”‚  - ECS Agent (EC2)                â”‚
â”‚  - Container Runtimeâ”‚  - Fargate (ä¸å¯è¦–)               â”‚
â”‚  - CNI / CSI        â”‚  - awsvpc (ENI)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å›³2: ECS Service â†’ Deployments â†’ Tasksï¼ˆä¸–ä»£ä¸¦èµ°â†’åæŸï¼‰

```plaintext
ECS Service
  â”œâ”€ desiredCount: 3
  â”‚
  â”œâ”€ deployments:
  â”‚   â”œâ”€ PRIMARY (my-app:2)  â† æ–°revision
  â”‚   â”‚   â”œâ”€ desired: 3
  â”‚   â”‚   â”œâ”€ running: 3
  â”‚   â”‚   â””â”€ pending: 0
  â”‚   â”‚
  â”‚   â””â”€ ACTIVE (my-app:1)   â† æ—§revision
  â”‚       â”œâ”€ desired: 0      â† åæŸå®Œäº†
  â”‚       â”œâ”€ running: 0
  â”‚       â””â”€ pending: 0
  â”‚
  â””â”€ Tasks:
      â”œâ”€ Task-A (my-app:2) â†’ RUNNING
      â”œâ”€ Task-B (my-app:2) â†’ RUNNING
      â””â”€ Task-C (my-app:2) â†’ RUNNING
```

### å›³3: reconciliation loopï¼ˆinputs/outputs ã¨åˆ¶ç´„ï¼‰

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ECS Service Scheduler                    â”‚
â”‚                                                       â”‚
â”‚  ã€å…¥åŠ›ã€‘                                             â”‚
â”‚   - deployments (desired/running/pending)            â”‚
â”‚   - task state (RUNNING/PENDING/STOPPED)             â”‚
â”‚   - health check çµæœ                                 â”‚
â”‚   - capacity provider ç©ºãçŠ¶æ³                        â”‚
â”‚                                                       â”‚
â”‚  ã€åˆ¶ç´„ã€‘                                             â”‚
â”‚   - minimumHealthyPercent (æœ€ä½å¥å…¨æ€§)               â”‚
â”‚   - maximumPercent (æœ€å¤§ä¸¦èµ°æ•°)                      â”‚
â”‚                                                       â”‚
â”‚  ã€åˆ¤æ–­ãƒ»å‡ºåŠ›ã€‘                                       â”‚
â”‚   â†’ RunTask (æ–°ã—ã„Taskèµ·å‹•)                         â”‚
â”‚   â†’ StopTask (å¤ã„Taskåœæ­¢)                          â”‚
â”‚   â†’ å¾…æ©Ÿ (åˆ¶ç´„ã‚’æº€ãŸã™ã¾ã§ä½•ã‚‚ã—ãªã„)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å‚è€ƒæ–‡çŒ®

### ECS å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Amazon ECS Developer Guide](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/)
- [Amazon ECS Services](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/ecs_services.html)
- [Amazon ECS Task Definitions](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task_definitions.html)
- [Amazon ECS Deployment Types](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/deployment-types.html)
- [Amazon ECS Capacity Providers](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/cluster-capacity-providers.html)
- [Task Networking with awsvpc Mode](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-networking.html)
- [Amazon ECS Task IAM Roles](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-iam-roles.html)

### Kubernetes å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Kubernetes Documentation](https://kubernetes.io/docs/home/)
- [Kubernetes Concepts: Workloads](https://kubernetes.io/docs/concepts/workloads/)
- [Deployments](https://kubernetes.io/docs/concepts/workloads/controllers/deployment/)
- [Pods](https://kubernetes.io/docs/concepts/workloads/pods/)
- [Kubernetes Scheduler](https://kubernetes.io/docs/concepts/scheduling-eviction/kube-scheduler/)
- [The Kubernetes API](https://kubernetes.io/docs/concepts/overview/kubernetes-api/)

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è§£èª¬

- [ECS Task Lifecycle](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/task-lifecycle.html)
- [Kubernetes Architecture](https://kubernetes.io/docs/concepts/architecture/)
- [Understanding Kubernetes Objects](https://kubernetes.io/docs/concepts/overview/working-with-objects/)

---

**Happy Container Orchestration!** ğŸš¢
