# ECS初心者がService ConnectとService Discoveryの違いを理解するまで

## はじめに

ECSを使ったマイクロサービス環境に触れる機会があり、「Service Connect」と「Service Discovery」という2つの似たような名前の機能が出てきて混乱しました。

調べていくうちに、それぞれの役割と使い分けが見えてきたので、同じように悩んでいる方の参考になればと思い、学んだことをまとめます。

## ECSの基本概念を整理する

まず、ECSの登場人物を整理しておきます。ここを押さえておくと後の話が分かりやすくなります。

<!-- TODO: 図を入れる -->

| 概念 | 役割 |
|------|------|
| **Cluster** | コンテナを動かす環境の入れ物。複数のServiceをまとめる |
| **Service** | 「このTaskを常に◯個動かしておいて」という定義。オートスケールやロードバランシングもここで設定 |
| **Task** | 実際に動いているコンテナの単位。Serviceによって起動・管理される |
| **Task Definition** | Taskの設計図。どのイメージを使うか、CPUやメモリはいくつか、などを定義 |

ポイントは、ServiceがTaskを管理しているという関係です。Taskが落ちたら自動で再起動してくれるのもServiceの仕事です。

## マイクロサービス間通信の課題

マイクロサービス構成では、複数のServiceが連携して動きます。例えば：

- `api-service`: フロントエンドからのリクエストを受ける
- `user-service`: ユーザー情報を管理する
- `order-service`: 注文情報を管理する

このとき、`api-service`から`user-service`を呼び出したい場合、どうやって宛先を指定するのでしょうか？

### IPアドレスは使えない

最初に思いつくのはIPアドレスですが、これには問題があります。

- Taskは停止・再起動するたびにIPアドレスが変わる
- オートスケールでTaskが増減する
- どのIPが生きているか分からない

つまり、**IPアドレスをハードコードすることはできない**のです。

### 名前解決という考え方

そこで登場するのが「名前解決」という仕組みです。

IPアドレスの代わりに、`user-service`のような名前でアクセスできるようにして、その名前から実際のIPアドレスへの変換を自動でやってもらう、という考え方です。

ECSでは、この名前解決を実現する方法として **Service Discovery** と **Service Connect** の2つがあります。

## Service Discovery（Cloud Map連携）とは

Service Discoveryは、AWS Cloud MapとRoute 53を使ったDNSベースの名前解決です。

### 仕組み

1. ECS ServiceをCloud Mapに登録する
2. Taskが起動すると、そのIPアドレスがCloud Mapに自動登録される
3. 他のサービスは `user-service.local` のようなDNS名でアクセスできる
4. Route 53がDNS名をIPアドレスに解決してくれる

<!-- TODO: 図を入れる -->

### 特徴

- **DNSベース**: 標準的なDNSの仕組みを使う
- **ECS以外からもアクセス可能**: LambdaやEC2など、どこからでもDNS名で解決できる
- **設定がやや複雑**: Cloud Mapの名前空間やサービスの設定が必要

### ユースケース

- Lambda → ECS の通信
- EC2 → ECS の通信
- ECS以外のサービスからECSにアクセスしたい場合全般

## Service Connectとは

Service Connectは、2022年に登場した比較的新しい機能で、ECS間の通信に特化しています。

### 仕組み

1. 各TaskにEnvoyプロキシがサイドカーとして自動で追加される
2. サービス間の通信はすべてこのプロキシを経由する
3. プロキシが名前解決やロードバランシングを行う

<!-- TODO: 図を入れる -->

### 特徴

- **設定が簡単**: ECS Serviceの設定だけで完結する
- **高機能**: リトライ、タイムアウト、ヘルスチェックなどが組み込み
- **可観測性**: メトリクスが自動で収集される
- **ECS内限定**: ECS Service間の通信にのみ使える

### ユースケース

- ECS Service ↔ ECS Service の通信
- マイクロサービス間の通信を簡単に設定したい場合

## Service Discovery と Service Connect の比較

| 観点 | Service Discovery | Service Connect |
|------|-------------------|-----------------|
| 名前解決の仕組み | DNS（Route 53） | Envoyプロキシ |
| 設定の手軽さ | やや複雑 | シンプル |
| ECS以外からのアクセス | ○ | × |
| ロードバランシング | DNSラウンドロビン | プロキシによる高度な分散 |
| リトライ・タイムアウト | アプリ側で実装 | 組み込み |
| メトリクス | 別途設定が必要 | 自動収集 |

## 使い分けの考え方

ここまでの内容を踏まえると、使い分けは以下のようになります。

### ECS間の通信 → Service Connect

ECS Service同士の通信であれば、Service Connectが適しています。設定が簡単で、リトライやメトリクスも組み込みで使えます。

### Lambda → ECS の通信 → Service Discovery

LambdaはECSの外にいるため、Service Connectは使えません。DNS名でアクセスできるService Discoveryを使います。

### 両方使うパターン

実際の環境では、両方を併用することもあります。

```
┌─────────────────────────────────────────────────────┐
│  ECS Cluster                                        │
│                                                     │
│   ┌──────────┐  Service Connect  ┌──────────┐      │
│   │ Service A │ ←───────────────→ │ Service B │      │
│   └──────────┘                   └──────────┘      │
│         ↑                                          │
│         │ Service Discovery (DNS)                  │
└─────────│───────────────────────────────────────────┘
          │
    ┌─────┴─────┐
    │  Lambda   │
    └───────────┘
```

- ECS内部の通信: Service Connect
- 外部（Lambda）からの通信: Service Discovery

このように、通信元がECS内か外かで使い分けるのが基本的な考え方です。

## まとめ

- ECSでマイクロサービス間通信をするには「名前解決」の仕組みが必要
- **Service Discovery**: DNSベース、ECS以外からもアクセス可能
- **Service Connect**: ECS間専用、設定が簡単で高機能
- 通信元がECS内か外かで使い分けるのが基本

最初は似たような名前で混乱しましたが、「誰がアクセスするか」という観点で整理すると、それぞれの役割が見えてきました。

同じように悩んでいる方の参考になれば幸いです。