# ECS初心者がService ConnectとService Discoveryの違いを理解するまで

> 本記事は、ECS を使ったマイクロサービス環境に触れる中で、私自身が「Service Connect と Service Discovery（Cloud Map）が何を解決していて、どう使い分けるのか」を理解するために調べたことをまとめたものです。

---

## 想定読者

* ECS を触り始めたばかりで、`Cluster / Service / Task` あたりがまだふわっとしている
* マイクロサービス間通信で出てくる **名前解決**（Service Discovery / Service Connect）が混乱ポイント
* 「結局どれを使えばいいの？」の見取り図が欲しい

## この記事で扱う範囲

* ECS の基本（最低限）
* **名前解決**と**到達性（経路）**の切り分け
* Service Discovery（Cloud Map）と Service Connect の違い
* 使い分けの考え方（ECS↔ECS / Lambda→ECS）

扱わない（深入りしない）もの：ALB の詳細、ゼロトラスト、mTLS、Observability のベストプラクティス、Network モードの全網羅 など

---

## 1. 導入

ECS を使ったマイクロサービス環境に触れる機会があり、サービス間通信まわり（特に **Service Connect** と **Service Discovery**）で用語が混ざりました。

* 「サービス名で呼べる」ってどういう意味？
* それは **DNS**？それとも **ルーティング**？
* Service Discovery と Service Connect は競合するの？併用するの？

本記事では、このあたりを初心者目線でほどいていきます。

---

## 2. ECSの基本概念を整理する

この章は、後の話（通信・名前解決）を理解するための前提整理です。

### 2.1 ECSの登場人物（最小セット）

* **Cluster**：タスクやサービスを置く“箱”
* **Task Definition**：コンテナの設計図（イメージ：Docker run の宣言）
* **Task**：Task Definition から起動された実体
* **Service**：Task を指定数維持し、更新（ローリング）なども面倒を見る

### 2.2 関係図（概念）

```text
Cluster
  ├─ Service A
  │    └─ Task Definition A
  │           ├─ Task A-1 (container ...)
  │           └─ Task A-2 (container ...)
  └─ Service B
       └─ Task Definition B
              └─ Task B-1
```

> ポイント：通信したいのは「Service A ⇄ Service B」だけど、ネットワーク的には「Task の実体（IP/Port）」に届く必要がある。

---

## 3. マイクロサービス間通信の課題

### 3.1 “見つける”問題

マイクロサービスでは、サービス同士が互いを呼び出します。

しかし、タスクの IP は（再起動・スケール・デプロイで）変わり得ます。

* IP をコードや設定に直書き → 破綻
* じゃあどうする？ → **名前解決**

### 3.2 まず分ける：名前解決（DNS）と到達性（経路）

ここを混ぜると沼ります。

* **名前解決（DNS）**：`service-a` → `10.0.1.23` のように宛先 IP を引ける
* **到達性（経路）**：その IP/Port に実際に通信が届く（VPC、サブネット、SG、ルートなど）

> 「DNS が引けない」のか「引けるけど届かない」のかで、見るべき場所が変わります。

---

## 4. Service Discovery（Cloud Map連携）とは

（ここでは ECS の **Service Discovery = AWS Cloud Map 連携** を指します）

### 4.1 何をしてくれる？

ざっくり言うと、**サービス（タスク群）を DNS 名で引けるようにする仕組み**です。

* サービスに紐づくタスクの情報を Cloud Map に登録
* その情報を Route 53（プライベート DNS）経由で名前解決できる

### 4.2 何が嬉しい？

* タスクの IP が変わっても、**同じ名前**で引ける
* ECS 以外（同一VPCにいる Lambda や EC2、別の内部システム）からも使いやすい

### 4.3 向いているユースケース

* **ECS以外**（Lambda/EC2/オンプレ接続先など）から ECS のタスクに名前で到達したい
* 伝統的な「DNSでサービスを見つける」モデルで揃えたい

---

## 5. Service Connectとは

### 5.1 何をしてくれる？（初心者向け）

Service Connect は、ECS の **サービス間通信を“ECS向けに扱いやすく”整える仕組み**です。

一般に、ECS上のサービス同士を呼び合うときに出てくる

* どの名前で呼ぶ？
* どのポート？
* 環境ごとの差（stg/prod）
* 監視やトラフィック制御

…みたいな散らかりを、まとまった形で扱えるようにします。

### 5.2 仕組みのイメージ（Envoy サイドカー）

Service Connect は多くの場合、タスクに **Envoy サイドカー**（通信の脇役コンテナ）を追加し、
アプリの示す宛先を“いい感じに”ルーティングできるようにします。

```text
[App Container]  ->  [Envoy Sidecar]  ->  (Service Connect 経由)  ->  相手サービス
```

> ここでは深追いしすぎず、「通信を受け渡す共通レイヤが入る」と理解しておくと十分です。

### 5.3 Service Discoveryとの違い（ざっくり比較）

| 観点          | Service Discovery（Cloud Map） | Service Connect          |
| ----------- | ---------------------------- | ------------------------ |
| 主な役割        | DNSベースの名前解決                  | ECSサービス間通信の標準化/制御（＋名前解決） |
| 対象          | ECS以外も含む“同一ネットワーク内のクライアント”   | 主に ECS 内のサービス間           |
| 仕組みのイメージ    | 「名前→IP」を引く                   | 「呼び先の解決＋通信の中継/制御レイヤ」     |
| 使うときに意識すること | VPC内DNS・TTL・ヘルスなど            | サイドカー、ポート、通信経路の設計        |

---

## 6. 使い分けの考え方

ここは「設計意図の断定」を避けつつ、要件から自然に導くのが安全です。

### 6.1 典型パターン：ECS間はService Connect、Lambda→ECSはService Discovery

* **ECS ↔ ECS**：Service Connect

  * ECS内のサービス間通信をまとめて扱いたい（標準化・運用容易性）
* **Lambda → ECS**：Service Discovery（Cloud Map）

  * Lambda が（設定次第で）ECSと同じ名前解決レイヤに乗らない/経路が異なる場合がある
  * DNSで名前を引けるほうが接続性を作りやすいことが多い

> 注意：Lambda を VPC に入れるかどうか、どのDNSを参照できるか、SG/ルートはどうか、で条件は変わります。

### 6.2 “なぜこうなるのか”を分解して説明する

使い分けの理由は、だいたい次の2軸です。

1. **名前解決のスコープ**（そのクライアントは、その名前を引ける場所にいる？）
2. **到達性**（引けたとして、実際に届く経路になってる？）

Service Connect は ECS 内の通信に強く、
Cloud Map は ECS 外（ただし同じVPCなど条件付き）にも広げやすい、という整理になります。

---

## 7. まとめ

* ECS をマイクロサービスとして運用すると、避けて通れないのが **サービス間通信**
* その通信用語はまず **名前解決（DNS）** と **到達性（経路）** に分けると混乱が減る
* Service Discovery（Cloud Map）は DNS でサービス（タスク群）を見つける仕組み
* Service Connect は ECS内のサービス間通信を“扱いやすく”標準化する仕組み
* 使い分けは要件ベースで：

  * ECS↔ECS：Service Connect が自然なことが多い
  * ECS外（例：Lambda）→ECS：Service Discovery が効く場面がある

---

## 付録（追記候補）

* デバッグの型：`DNS → 経路(SG/ルート) → アプリ(Port/Health)` の順で切る
* “名前は引けるのに繋がらない”ときに見るチェックリスト
* 参考リンク（AWS公式ドキュメント）
